---
import PromptCard from "./PromptCard.astro";
import { getCollection } from "astro:content";
import { getCategoryBySlug } from "../categories";

interface Props {
    category?: string;
}

const { category } = Astro.props;

let posts = await getCollection("blog");

// Filter by category if specified
if (category) {
    posts = posts.filter((post) => post.data.category === category);
}

// Sort posts by publication date
posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Helper to format time ago (simplified)
function timeAgo(date: Date) {
    const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + "y ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + "mo ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + "d ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + "h ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + "m ago";
    return Math.floor(seconds) + "s ago";
}

const prompts = posts.map((post) => ({
    type: "Blog Post", // Default type
    time: timeAgo(post.data.pubDate),
    title: post.data.title,
    description: post.data.description,
    prompt: post.data.prompt || "No prompt available",
    author: "Admin", // Default author
    views: "0", // Initial view count, updated by client
    copies: "0", // Initial copies count
    color: "purple", // Default color
    slug: post.id,
    category: post.data.category,
    image: post.data.heroImage,
}));

const categoryInfo = category ? getCategoryBySlug(category) : null;
---

<section class="max-w-7xl mx-auto px-4 sm:px-6 py-12">
    {
        categoryInfo && (
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">
                    {categoryInfo.name}
                </h1>
                <p class="text-secondary text-sm mb-1">
                    {categoryInfo.description}
                </p>
                <p class="text-neutral-500 text-xs">
                    {prompts.length} prompt{prompts.length !== 1 ? "s" : ""}{" "}
                    available
                </p>
            </div>
        )
    }

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {prompts.map((prompt) => <PromptCard {...prompt} />)}
    </div>

    {
        prompts.length === 0 && (
            <div class="text-center py-12">
                <p class="text-secondary text-sm">
                    No prompts found in this category yet.
                </p>
            </div>
        )
    }

    {
        prompts.length > 0 && (
            <div class="mt-12 text-center">
                <button class="text-xs font-medium text-secondary hover:text-white border border-border hover:border-neutral-600 bg-surface px-6 py-2.5 rounded-md transition-all">
                    Load more prompts
                </button>
            </div>
        )
    }
</section>

<script>
    import { supabase } from "../lib/supabase";

    // Store view counts globally for sorting
    let viewCounts: Map<string, number> = new Map();

    const fetchViews = async () => {
        const viewElements = document.querySelectorAll(".view-count");
        const slugs = Array.from(viewElements)
            .map((el) => el.getAttribute("data-slug"))
            .filter(Boolean) as string[];

        if (slugs.length === 0) return;

        // Fetch counts for all slugs
        const { data, error } = await supabase
            .from("post_views")
            .select("slug, count")
            .in("slug", slugs);

        if (data && !error) {
            // Create a map for easy lookup
            viewCounts = new Map(data.map((item) => [item.slug, item.count]));

            // Update elements
            viewElements.forEach((el) => {
                const slug = el.getAttribute("data-slug");
                if (slug && viewCounts.has(slug)) {
                    const count = viewCounts.get(slug) || 0;
                    el.textContent =
                        count >= 1000
                            ? `${(count / 1000).toFixed(1)}k`
                            : count.toString();
                }
            });
        }
    };

    const sortCards = (sortType: string) => {
        const grid = document.querySelector(".grid");
        if (!grid) return;

        const cards = Array.from(grid.querySelectorAll("article"));

        cards.sort((a, b) => {
            if (sortType === "popular") {
                const slugA =
                    a.querySelector(".view-count")?.getAttribute("data-slug") ||
                    "";
                const slugB =
                    b.querySelector(".view-count")?.getAttribute("data-slug") ||
                    "";
                const viewsA = viewCounts.get(slugA) || 0;
                const viewsB = viewCounts.get(slugB) || 0;
                return viewsB - viewsA; // Descending by views
            } else {
                // Sort by time (newest first) - use the time text as fallback
                const timeA =
                    a.querySelector(".text-neutral-500")?.textContent || "";
                const timeB =
                    b.querySelector(".text-neutral-500")?.textContent || "";
                // Parse time strings like "2d ago", "1h ago", etc.
                const parseTime = (t: string) => {
                    const match = t.match(/(\d+)([smhdwy])/);
                    if (!match) return 0;
                    const [, num, unit] = match;
                    const multipliers: Record<string, number> = {
                        s: 1,
                        m: 60,
                        h: 3600,
                        d: 86400,
                        w: 604800,
                        mo: 2592000,
                        y: 31536000,
                    };
                    return parseInt(num) * (multipliers[unit] || 1);
                };
                return parseTime(timeA) - parseTime(timeB); // Ascending (smaller = more recent)
            }
        });

        // Reorder DOM
        cards.forEach((card) => grid.appendChild(card));
    };

    // Listen for sort change events
    window.addEventListener("sort-change", ((e: CustomEvent) => {
        sortCards(e.detail.sort);
    }) as EventListener);

    // Run on load
    fetchViews();
</script>
